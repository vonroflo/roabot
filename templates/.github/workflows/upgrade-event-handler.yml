name: Upgrade Event Handler

on:
  workflow_dispatch:

concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  upgrade:
    runs-on: self-hosted
    steps:
      - name: Upgrade thepopebot
        run: |
          # Phase 1: Update package and build (but don't swap yet)
          docker exec thepopebot-event-handler bash -c '
            export GH_TOKEN=$(grep "^GH_TOKEN=" /app/.env | cut -d= -f2-)
            echo "${GH_TOKEN}" | gh auth login --with-token
            gh auth setup-git

            git fetch origin main
            git reset --hard origin/main

            npm update thepopebot
            npx thepopebot init
            npm install --omit=dev

            rm -rf .next-new
            NEXT_BUILD_DIR=.next-new npm run build
          '

          # Phase 2: Pull new image and restart container
          cd /project
          docker compose pull event-handler
          docker compose up -d event-handler

          # Phase 3: Swap build and reload inside new container
          docker exec thepopebot-event-handler bash -c '
            mv .next .next-old 2>/dev/null || true
            mv .next-new .next
            npx pm2 reload all
            rm -rf .next-old
          '
